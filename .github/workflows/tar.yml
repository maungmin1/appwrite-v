name: Build and Release Appwrite

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/main.js'
      - 'package.json'
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Commit history á€›á€–á€­á€¯á€·á€¡á€á€½á€€á€º

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Validate required files
      run: |
        if [ ! -f "src/main.js" ]; then
          echo "âŒ src/main.js not found!"
          exit 1
        fi
        if [ ! -f "package.json" ]; then
          echo "âŒ package.json not found!"
          exit 1
        fi
        echo "âœ… Required files found"
        
    - name: Create deployment archive
      run: |
        # Appwrite Function á€¡á€á€½á€€á€º main.js á€”á€²á€· package.json á€€ Root á€™á€¾á€¬ á€›á€¾á€­á€”á€±á€á€¬ á€•á€­á€¯á€€á€±á€¬á€„á€ºá€¸á€•á€«á€á€šá€º
        # á€’á€«á€€á€¼á€±á€¬á€„á€·á€º Folder á€‘á€²á€™á€‘á€Šá€·á€ºá€˜á€² á€á€­á€¯á€€á€ºá€›á€­á€¯á€€á€º compress á€œá€¯á€•á€ºá€•á€«á€™á€šá€º
        tar -czf Appwrite.tar.gz src/ package.json
        echo "ðŸ“¦ Archive created: Appwrite.tar.gz"
        echo "ðŸ“Š Archive size: $(du -h Appwrite.tar.gz | cut -f1)"
        
    - name: Generate release notes
      id: release_notes
      run: |
        LATEST_COMMIT=$(git log -1 --pretty=format:"%s")
        SHORT_SHA=$(git rev-parse --short HEAD)
        
        cat > release_notes.md << EOF
        ## ðŸš€ Appwrite Functions Deployment Package

        â­ **Quick Start:**
        1. Appwrite Console á€žá€­á€¯á€·á€žá€½á€¬á€¸á€•á€«á‹
        2. Function á€¡á€žá€…á€ºá€á€…á€ºá€á€¯ á€á€Šá€ºá€†á€±á€¬á€€á€ºá€•á€«á‹
        3. Manual Deployment á€€á€­á€¯á€›á€½á€±á€¸á€•á€¼á€®á€¸ á€¤ **Appwrite.tar.gz** á€€á€­á€¯ Upload á€œá€¯á€•á€ºá€•á€«á‹
        4. Entrypoint á€€á€­á€¯ \`src/main.js\` á€Ÿá€¯ á€žá€á€ºá€™á€¾á€á€ºá€•á€«á‹

        ---
        **Build Info:**
        - **Commit:** ${SHORT_SHA}
        - **Message:** ${LATEST_COMMIT}
        - **Date:** $(date '+%Y-%m-%d %H:%M')
        EOF
        
    - name: Create or Update Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "Appwrite-latest"
        name: "Appwrite Functions Build"
        body_path: release_notes.md
        files: Appwrite.tar.gz
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
